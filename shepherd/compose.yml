version: "3.8"

services:
  app:
    image: containrrr/shepherd
    environment:
      TZ: 'Australia/Adelaide'
      FILTER_SERVICES: ''
      IGNORELIST_SERVICES: "shepherd_scheduler,shepherd_app"
      RUN_ONCE_AND_EXIT: "true"
      SLEEP_TIME: "5m"
      BLACKLIST_SERVICES: "shepherd_scheduler,shepherd_app"
      WITH_REGISTRY_AUTH: "true"
      WITH_INSECURE_REGISTRY: "false"
      WITH_NO_RESOLVE_IMAGE: "false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      replicas: 0
      restart_policy:
        condition: none
      labels:
        - swarm.cronjob.enable=true
        # Start service every day at 2 AM (to avoid peak usage)
        - swarm.cronjob.schedule=0 0 2 * * *
        - swarm.cronjob.skip-running=true
      placement:
        constraints:
          - node.role == manager

  scheduler:
    image: crazymax/swarm-cronjob:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - "TZ=Australia/Adelaide"
      - "LOG_LEVEL=info"
      - "LOG_JSON=false"
    deploy:
      placement:
        constraints:
          - node.role == manager

networks:
  default:
    external: true
    name: dokploy-network